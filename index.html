<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Citas Gavabarber</title>
<style>
body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
h1 { text-align:center; color:#222; }
.controls, .week-nav { display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px; flex-wrap:wrap; gap:10px; }
button { padding: 8px 12px; border:none; border-radius:6px; cursor:pointer; background:#2196f3; color:white; }
button:hover { background:#1976d2; }
#counter { font-weight:bold; }
table { width:100%; border-collapse: collapse; margin-top:10px; }
th, td { border:1px solid #ccc; padding:0; text-align:center; height:35px; }
th { background:#2196f3; color:white; }
td.slot { min-width:80px; position:relative; }

/* Input ocupa toda la celda */
td.slot input {
  width: 100%;
  height: 100%;
  border: none;
  padding: 5px;
  box-sizing: border-box;
  text-align: center;
  font-size: 14px;
  background: transparent;
}

/* Estados de las celdas */
td.libre input { background:#c8e6c9; cursor:text; }           
td.ocupado input { background:#ef9a9a; cursor:text; }        
td.ocupado-filtro input { background:#b0b0b0; cursor:text; } 
td.pasado input { background:#e0e0e0; cursor:not-allowed; }  

td.libre:hover input { background:#a5d6a7; }           
td.ocupado:hover input { background:#ef6c6c; }         
td.ocupado-filtro:hover input { background:#999999; }  

@media (max-width: 768px) {
  table { display: block; overflow-x: auto; white-space: nowrap; }
  th, td { padding: 0 5px; font-size: 14px; min-width: 60px; height:30px; }
  .controls, .week-nav { flex-direction: column; align-items: flex-start; gap: 5px; }
  button { padding: 6px 10px; font-size: 14px; }
}
</style>
</head>
<body>

<h1>Citas Gavabarber</h1>

<div class="week-nav">
  <button id="prevWeek">← Semana anterior</button>
  <span id="weekLabel">Semana actual</span>
  <button id="nextWeek">Semana siguiente →</button>
</div>

<div class="controls">
  <button id="showAll">Mostrar todas las citas</button>
  <button id="showFree">Mostrar solo libres</button>
  <div id="counter">Clientes agendados: 0</div>
</div>

<table id="calendar">
<thead><tr><th>Hora</th></tr></thead>
<tbody></tbody>
</table>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAjXrpMMKPMc9KsrpZ_ymv8CMAKME8l0Fs",
  authDomain: "agenda-barberia-59b4c.firebaseapp.com",
  databaseURL: "https://agenda-barberia-59b4c-default-rtdb.firebaseio.com",
  projectId: "agenda-barberia-59b4c",
  storageBucket: "agenda-barberia-59b4c.firebasestorage.app",
  messagingSenderId: "541388928781",
  appId: "1:541388928781:web:89db455c12f67b3fee6244",
  measurementId: "G-LG0DL5RXP0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const dias=["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];
const horas=[];
for(let h=9;h<=20;h++){ horas.push(h+":00"); horas.push(h+":30"); }

const table=document.getElementById("calendar");
const thead=table.querySelector("thead tr");
const tbody=table.querySelector("tbody");
const counterDiv=document.getElementById("counter");
const weekLabel = document.getElementById("weekLabel");

let showOnlyFree=false;
let currentMonday = getMonday(new Date());

function getMonday(d){
  const date = new Date(d);
  const day = date.getDay();
  const diff = (day === 0 ? -6 : 1) - day;
  date.setDate(date.getDate() + diff);
  date.setHours(0,0,0,0);
  return date;
}

function crearTabla(){
  tbody.innerHTML = "";
  horas.forEach(hora=>{
    const tr=document.createElement("tr");
    const thHora=document.createElement("th");
    thHora.textContent=hora;
    tr.appendChild(thHora);

    dias.forEach(dia=>{
      const td=document.createElement("td");
      td.className="slot";
      td.dataset.dia = dia;
      td.dataset.hora = hora;
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

function getWeekDates(monday){
  return dias.map((dia,index)=>{
    const d = new Date(monday);
    d.setDate(d.getDate() + index);
    const day = d.getDate().toString().padStart(2,'0');
    const month = (d.getMonth()+1).toString().padStart(2,'0');
    return `${dia} ${day}/${month}`;
  });
}

function actualizarHeader(){
  thead.querySelectorAll("th:not(:first-child)").forEach(th=>th.remove());
  const fechas = getWeekDates(currentMonday);
  fechas.forEach(fechaStr=>{
    const th=document.createElement("th");
    th.textContent = fechaStr;
    thead.appendChild(th);
  });
}

function actualizarContador(){
  let total=0;
  tbody.querySelectorAll("td.slot input").forEach(input=>{
    if(input.value.trim()!=="") total++;
  });
  counterDiv.textContent="Clientes agendados: "+total;
}

function aplicarFiltro(){
  tbody.querySelectorAll("td.slot").forEach(td=>{
    td.classList.remove("ocupado-filtro");
    if(td.classList.contains("ocupado") && showOnlyFree){
      td.classList.add("ocupado-filtro");
    }
    const input = td.querySelector("input");
    if(td.classList.contains("pasado")){
      td.classList.remove("libre","ocupado","ocupado-filtro");
      td.classList.add("pasado");
      if(input) input.disabled = true;
    } else if(input) {
      input.disabled = false;
    }
  });
}

function actualizarEstado(td){
  const val = td.querySelector("input").value.trim();
  td.classList.remove("libre","ocupado","ocupado-filtro","pasado");
  const slotDate = new Date(currentMonday);
  slotDate.setDate(slotDate.getDate() + dias.indexOf(td.dataset.dia));
  const now = new Date(); now.setHours(0,0,0,0);

  if(slotDate < now){
    td.classList.add("pasado");
  } else if(val===""){
    td.classList.add("libre");
  } else {
    td.classList.add("ocupado");
    if(showOnlyFree){
      td.classList.add("ocupado-filtro");
    }
  }
  aplicarFiltro();
  actualizarContador();
}

function cargarSemana(){
  crearTabla();
  actualizarHeader();
  db.ref("citas").off();

  db.ref("citas").once("value").then(snap=>{
    const data = snap.val() || {};

    tbody.querySelectorAll("td.slot").forEach(td=>{
      const key = `${td.dataset.dia}_${td.dataset.hora}`;
      const val = data[key] || "";

      if(!td.querySelector("input")){
        const input = document.createElement("input");
        input.value = val;
        td.appendChild(input);

        input.onblur = ()=>{ 
          db.ref("citas/"+key).set(input.value.trim());
          actualizarEstado(td);
        };
        input.onkeydown = e=>{
          if(e.key==="Enter"){
            db.ref("citas/"+key).set(input.value.trim());
            actualizarEstado(td);
            input.blur();
          }
        };
      } else {
        td.querySelector("input").value = val;
      }

      actualizarEstado(td);
    });

    weekLabel.textContent = `Semana del ${currentMonday.getDate()}/${currentMonday.getMonth()+1}`;
  });
}

document.getElementById("showAll").onclick = ()=>{ showOnlyFree=false; aplicarFiltro(); };
document.getElementById("showFree").onclick = ()=>{ showOnlyFree=true; aplicarFiltro(); };
document.getElementById("prevWeek").onclick = ()=>{ currentMonday.setDate(currentMonday.getDate()-7); cargarSemana(); };
document.getElementById("nextWeek").onclick = ()=>{ currentMonday.setDate(currentMonday.getDate()+7); cargarSemana(); };

cargarSemana();
</script>
</body>
</html>
